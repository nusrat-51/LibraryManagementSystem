using System;
using System.Linq;
using System.Threading.Tasks;
using LibraryManagementSystem.Data;
using LibraryManagementSystem.Models;
using LibraryManagementSystem.ViewModels.Librarian;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace LibraryManagementSystem.Controllers
{
    [Authorize(Roles = "Librarian,Admin")]
    public class LibrarianController : Controller
    {
        private readonly LibraryContext _context;

        public LibrarianController(LibraryContext context)
        {
            _context = context;
        }

        // ===========================
        //  DASHBOARD
        // ===========================
        public async Task<IActionResult>
    Dashboard()
    {
    var today = DateTime.Today;

    // Counts for the top cards
    var totalBooks = await _context.Books.CountAsync();

    var todayIssues = await _context.IssueRecords
    .CountAsync(i => i.IssueDate.Date == today);

    var overdueCount = await _context.IssueRecords
    .CountAsync(i =>
    i.Status == "Issued" &&
    !i.ReturnDate.HasValue &&
    i.IssueDate.AddDays(14).Date < today);

    var reservations = await _context.Reservations.CountAsync();

    var vm = new LibrarianDashboardVM
    {
    TotalBooks = totalBooks,
    IssuedToday = todayIssues,
    OverdueCount = overdueCount,
    ActiveReservations = reservations
    };

    return View(vm); // Views/Librarian/Dashboard.cshtml
    }

    // ===========================
    //  ISSUES PAGE (LIST + FILTERS)
    // ===========================
    // /Librarian/Issues?scope=all|today|overdue|returned
    public async Task<IActionResult>
        Issues(string scope = "all")
        {
        var today = DateTime.Today;

        var query = _context.IssueRecords
        .Include(i => i.Book)
        .OrderByDescending(i => i.IssueDate)
        .AsQueryable();

        switch (scope?.ToLowerInvariant())
        {
        case "today":
        query = query.Where(i => i.IssueDate.Date == today);
        break;

        case "overdue":
        query = query.Where(i =>
        i.Status == "Issued" &&
        !i.ReturnDate.HasValue &&
        i.IssueDate.AddDays(14).Date < today);
        break;

        case "returned":
        query = query.Where(i => i.Status == "Returned");
        break;

        default:
        scope = "all";
        break;
        }

        var list = await query.ToListAsync();

        var vm = new LibrarianIssuesViewModel
        {
        Scope = scope,
        TotalIssues = await _context.IssueRecords.CountAsync(),
        TodayIssues = await _context.IssueRecords
        .CountAsync(i => i.IssueDate.Date == today),
        OverdueCount = await _context.IssueRecords
        .CountAsync(i =>
        i.Status == "Issued" &&
        !i.ReturnDate.HasValue &&
        i.IssueDate.AddDays(14).Date < today),
        ReturnedToday = await _context.IssueRecords
        .CountAsync(i =>
        i.Status == "Returned" &&
        i.ReturnDate.HasValue &&
        i.ReturnDate.Value.Date == today),
        Issues = list
        };

        return View(vm); // Views/Librarian/Issues.cshtml
        }

        // ===========================
        //  BOOK LIST PAGE
        // ===========================
        public async Task<IActionResult>
            ManageBooks()
            {
            var books = await _context.Books.ToListAsync();
            return View(books);
            }

            // CREATE BOOK (GET)
            public IActionResult CreateBook()
            {
            return View();
            }

            // CREATE BOOK (POST)
            [HttpPost]
            [ValidateAntiForgeryToken]
            public async Task<IActionResult>
                CreateBook(Book model)
                {
                if (!ModelState.IsValid)
                return View(model);

                model.AvailableCopies = model.TotalCopies;

                _context.Books.Add(model);
                await _context.SaveChangesAsync();

                TempData["Success"] = "Book added successfully!";
                return RedirectToAction(nameof(ManageBooks));
                }

                // EDIT BOOK (GET)
                public async Task<IActionResult>
                    EditBook(int id)
                    {
                    var book = await _context.Books.FindAsync(id);
                    if (book == null) return NotFound();

                    return View(book);
                    }

                    // EDIT BOOK (POST)
                    [HttpPost]
                    [ValidateAntiForgeryToken]
                    public async Task<IActionResult>
                        EditBook(Book model)
                        {
                        if (!ModelState.IsValid)
                        return View(model);

                        var book = await _context.Books.FindAsync(model.Id);
                        if (book == null) return NotFound();

                        book.Title = model.Title;
                        book.Author = model.Author;
                        book.Category = model.Category;
                        book.TotalCopies = model.TotalCopies;
                        book.AvailableCopies = model.TotalCopies;

                        await _context.SaveChangesAsync();

                        TempData["Success"] = "Book updated successfully!";
                        return RedirectToAction(nameof(ManageBooks));
                        }

                        // DELETE BOOK (GET)
                        public async Task<IActionResult>
                            DeleteBook(int id)
                            {
                            var book = await _context.Books.FindAsync(id);
                            if (book == null) return NotFound();

                            return View(book);
                            }

                            // DELETE BOOK (POST)
                            [HttpPost, ActionName("DeleteBook")]
                            [ValidateAntiForgeryToken]
                            public async Task<IActionResult>
                                DeleteConfirmed(int id)
                                {
                                var book = await _context.Books.FindAsync(id);
                                if (book == null) return NotFound();

                                _context.Books.Remove(book);
                                await _context.SaveChangesAsync();

                                TempData["Success"] = "Book deleted successfully!";
                                return RedirectToAction(nameof(ManageBooks));
                                }

                                // BOOK DETAILS
                                public async Task<IActionResult>
                                    BookDetails(int id)
                                    {
                                    var book = await _context.Books.FindAsync(id);
                                    if (book == null) return NotFound();

                                    return View(book);
                                    }
                                    }
                                    }
